image:
  distribution: debian
  release: bookworm
  architecture: amd64
  variant: default
  cmd: [ "/usr/src/app/conf/entrypoint.sh" ]

source:
  downloader: debootstrap
  url: https://deb.debian.org/debian
  suite: bookworm
  variant: minbase

targets:
  lxc:
    create_message: |
      You just built a custom Debian image with Python 3.13.

packages:
  manager: apt
  update: true
  cleanup: true
  sets:
    - action: install
      stages: [ build ]
      packages:
        - build-essential
        - libffi-dev
        - libsasl2-dev
        - libldap-dev
        - libjpeg-dev
        - postgresql-server-dev-17
    - action: install
      packages:
        - python3
        - python3-pip
        - supervisor
        - curl
        - libjpeg-turbo-progs
        - argon2
        - tzdata
        - ldap-utils
        - swig
        - postgresql-client-17
        - postgresql-common
        - gnupg

environment:
  variables:
    - { key: PYTHONDONTWRITEBYTECODE, value: "1" }
    - { key: PYTHONUNBUFFERED,      value: "1" }
    - { key: PATH,                  value: "/root/.local/bin:$PATH" }
    - { key: GUNICORN_CMD_ARGS,     value: "--workers 4 -b 0.0.0.0:8000" }

files:
  - generator: copy
    source: .
    path: /usr/src/app
  - generator: copy
    source: conf/supervisor.conf
    path: /etc/supervisord.conf
  - generator: copy
    source: conf/entrypoint.sh
    path: /usr/src/app/conf/entrypoint.sh
    mode: "0755"

actions:
  - trigger: post-packages
    action: |
      echo "deb [arch=amd64] https://apt.postgresql.org/pub/repos/apt bookworm-pgdg main" \
        > /etc/apt/sources.list.d/pgdg.list
      curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -
      apt-get update -y
      echo 'INPUT ( libldap.so )' > /usr/lib/libldap_r.so

  - trigger: post-files
    action: |
      python3 -m pip install --no-cache-dir --user -r /usr/src/app/requirements.txt
      date -I > /usr/src/app/BUILD.txt
      apt-get purge -y build-essential libffi-dev libsasl2-dev libldap-dev \
                       libjpeg-dev postgresql-server-dev-17
      apt-get autoremove -y --purge
      apt-get clean
      rm -rf /var/lib/apt/lists/*
      chmod +x /usr/src/app/conf/entrypoint.sh
