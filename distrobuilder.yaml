# distrobuilder.yaml – compatible with distrobuilder ≥ 3.1
# Debian bookworm base, Python 3.13 runtime

image:
  distribution: debian
  release: bookworm
  architecture: amd64
  variant: default

source:
  downloader: debootstrap
  url: https://deb.debian.org/debian
  suite: bookworm
  variant: minbase

targets:
  lxc:
    create_message: "EvilFlowersCatalog Debian based image (built via GitHub Actions)"

packages:
  manager: apt
  update: true
  cleanup: true
  sets:
    - action: install
      packages:
        - build-essential
        - libffi-dev
        - libsasl2-dev
        - libldap-dev
        - libjpeg-dev
        - postgresql-client
    - action: install
      packages:
        - python3
        - python3-pip
        - supervisor
        - curl
        - libjpeg-turbo-progs
        - argon2
        - tzdata
        - ldap-utils
        - swig
        - postgresql-common
        - gnupg

environment:
  variables:
    - { key: PYTHONDONTWRITEBYTECODE, value: "1" }
    - { key: PYTHONUNBUFFERED, value: "1" }
    - { key: PATH, value: "/root/.local/bin:$PATH" }
    - { key: GUNICORN_CMD_ARGS, value: "--workers 4 -b 0.0.0.0:8000" }

files:
  - generator: copy
    source: .
    path: /usr/src/app
  - generator: copy
    source: conf/supervisor.conf
    path: /etc/supervisord.conf
  - generator: copy
    source: conf/entrypoint.sh
    path: /usr/src/app/conf/entrypoint.sh
    mode: "0755"

actions:
  - trigger: post-packages
    action: |
      echo 'INPUT ( libldap.so )' > /usr/lib/libldap_r.so
  - trigger: post-files
    action: |
      python3 -m pip install --no-cache-dir --user -r /usr/src/app/requirements.txt
      date -I > /usr/src/app/BUILD.txt
      apt-get purge -y build-essential libffi-dev libsasl2-dev libldap-dev libjpeg-dev
      apt-get autoremove -y --purge
      apt-get clean
      rm -rf /var/lib/apt/lists/*
      chmod +x /usr/src/app/conf/entrypoint.sh
  - trigger: post-files
    action: |
      /usr/src/app/conf/entrypoint.sh
